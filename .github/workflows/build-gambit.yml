name: Build Gambit

on:
  push:
    branches: [ build-gambit, build-gambit-patched ]

jobs:
  Windows-mingw:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Fetch Tags
      run: git fetch --prune --unshallow

    - name: Install MSYS2
      uses: eine/setup-msys2@v0
      with:
        update: true
        install: "autoconf git make mingw-w64-x86_64-gcc mingw-w64-x86_64-make mingw-w64-x86_64-libwinpthread-git"
        path-type: inherit

    - name: Build Gambit
      shell: cmd
      run: msys2do ./.github/workflows/build-gambit.sh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v1
      with:
        name: gambit-win-x64-mingw
        path: dist/

  Windows-msvc:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Fetch Tags
      run: git fetch --prune --unshallow

    - name: Install MSYS2
      uses: eine/setup-msys2@v0
      with:
        update: true
        path-type: inherit
        msystem: MSYS

    - name: Install Dependencies
      shell: cmd
      run: msys2do pacman -S --noconfirm autoconf make patch

    - name: Build Gambit
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64 -vcvars_ver=14.16
        set CC="cl"
        call msys2do ./.github/workflows/build-gambit.sh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v1
      with:
        name: gambit-win-x64-msvc
        path: dist/

  Linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Fetch Tags
      run: git fetch --prune --unshallow

    - name: Build Gambit
      run: ./.github/workflows/build-gambit.sh

    - name: Upload Artifact
      uses: actions/upload-artifact@v1
      with:
        name: gambit-linux-x64
        path: dist/

  MacOS:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2

    - name: Fetch Tags
      run: git fetch --prune --unshallow

    - name: Build Gambit
      run: |
        export CC=gcc-9
        ./.github/workflows/build-gambit.sh
        tar -cvzf gambit-macos-x86_64.tar.gz dist/

    - name: Upload Artifact
      uses: actions/upload-artifact@v1
      with:
        name: gambit-macos-x86_64
        path: gambit-macos-x86_64.tar.gz

  CreateRelease:
    runs-on: ubuntu-latest
    needs: [Windows-mingw, Linux, macOS]

    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v2

    - name: Prepare Packages
      run: |
        cd ./gambit-linux-x64
        zip -r ../gambit-linux-x64.zip ./*
        cd ../gambit-macos-x64
        zip -r ../gambit-macos-x64.zip ./*
        cd ../gambit-win-x64-mingw
        zip -r ../gambit-win-x64-mingw.zip ./*
        cd ..

    - name: Publish Release Artifact
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Fake a package.json to make publish-release happy
        echo "{}" > package.json
        hash=${GITHUB_SHA:0:7}
        npx publish-release --token $GITHUB_TOKEN --repo gambit --owner daviwil --name latest-$hash --tag latest-$hash --notes="Automated Build" --assets gambit-linux-x64.zip,gambit-macos-x86_64/gambit-macos-x86_64.tar.gz,gambit-win-x64-mingw.zip --reuseRelease --target_commitish $GITHUB_SHA
